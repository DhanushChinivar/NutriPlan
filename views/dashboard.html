<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - NutriPlan</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="logo">
        <img src="/images/logo.png" alt="NutriPlan Logo" class="logo-img">
        <h2>NutriPlan</h2>
      </div>
      <div class="user-info">
        <img src="/images/user.png" alt="User" class="user-avatar">
        <p>Hello! <span id="userName">User</span></p>
        <small id="userEmail">user@email.com</small>
      </div>
      <nav class="sidebar-nav">
        <a href="/dashboard" class="active">Dashboard</a>
        <a href="#">Meal Plans</a>
        <a href="#">Nutrition</a>
        <a href="#">Grocery List</a>
        <a href="#">Profile</a>
        <a href="#">Update Preferences</a>
        <a href="/" class="logout">Log out</a>
      </nav>
    </aside>

    <main class="main-content">
      <div class="dashboard-metrics">
        <div class="metric-box">
          <p>Today's Calories</p>
          <strong>1800 kcal</strong>
        </div>
        <div class="metric-box">
          <p>Recipes Saved</p>
          <strong>12</strong>
        </div>
        <div class="metric-box">
          <p>Calorie Consumption</p>
          <strong>2.5 Litres, 1300 kcal</strong>
        </div>
      </div>

      <!-- Generate Meal Plan Section -->
      <section class="generate-meal-plan">
        <button id="generateBtn">Generate Meal Plan</button>
      </section>

      <!-- Meal Plan Result -->
      <div id="mealPlanContainer" class="recipe-list"></div>

      <section class="recent-recipes">
        <div class="section-header">
          <h3>Recently added recipes</h3>
          <a href="#" class="view-all">View all</a>
        </div>
        <div class="recipe-list">
          <div class="recipe-card">
            <img src="/images/salad.jpg" alt="Salad">
            <div>
              <h4>Carrot & Mixed Bean Salad with Tahini Dressing</h4>
              <p><span>üïí 15 minutes</span> <span>ü•ï 10 ingredients</span></p>
            </div>
          </div>

          <div class="recipe-card">
            <img src="/images/horchata.jpg" alt="Horchata">
            <div>
              <h4>Horchata</h4>
              <p><span>üïí 1 hour 30 minutes</span> <span>ü•õ 12 ingredients</span></p>
            </div>
          </div>

          <div class="recipe-card">
            <img src="/images/stew.jpg" alt="Stew">
            <div>
              <h4>Dominican Chicken Stew</h4>
              <p><span>üïí 8 hours 20 minutes</span> <span>üçó 9 ingredients</span></p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Script for Email Handling and API Integration -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const storedEmail = localStorage.getItem("nutriplanEmail") || "user@email.com";
      document.getElementById("userEmail").textContent = storedEmail;

      // Optional: update user name from email prefix
      const userName = storedEmail.split("@")[0];
      document.getElementById("userName").textContent = userName.charAt(0).toUpperCase() + userName.slice(1);

      document.getElementById("generateBtn").addEventListener("click", async () => {
        try {
          const response = await fetch("/api/meals/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ email: storedEmail })
          });

          const data = await response.json();
          const container = document.getElementById("mealPlanContainer");
          container.innerHTML = ""; // Clear previous meals

          if (data.mealPlan && data.mealPlan.length > 0) {
            data.mealPlan.forEach(meal => {
              const card = `
                <div class="recipe-card">
                  <img src="/images/placeholder.jpg" alt="${meal.name}">
                  <div>
                    <h4>${meal.name}</h4>
                    <p>${meal.calories} kcal</p>
                    <p>Ingredients: ${meal.ingredients.join(", ")}</p>
                    <p>${meal.instructions.slice(0, 100)}...</p>
                  </div>
                </div>
              `;
              container.innerHTML += card;
            });
          } else {
            container.innerHTML = "<p>No meals found for your preferences.</p>";
          }

        } catch (error) {
          console.error("Error generating meal plan:", error);
          alert("Failed to generate meal plan. Please try again.");
        }
      });
    });
  </script>

  <!-- Optional styling -->
  <style>
    .generate-meal-plan {
      text-align: center;
      margin: 30px 0;
    }
    #generateBtn {
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 5px;
    }
    #generateBtn:hover {
      background-color: #45a049;
    }
  </style>
</body>
</html>
